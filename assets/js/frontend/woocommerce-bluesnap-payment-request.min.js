!function(n){var p={type:null,initialized:!1,session:null,source:woocommerce_bluesnap_payment_request_params.request_info_source,googlePayParams:{baseRequest:{apiVersion:2,apiVersionMinor:0},allowedCardNetworks:["AMEX","DISCOVER","INTERAC","JCB","MASTERCARD","MIR","VISA"],allowedCardAuthMethods:["PAN_ONLY","CRYPTOGRAM_3DS"]},init:function(){if(!p.initialized&&(p.type=p.getSupportedPaymentRequestType(),p.type&&n("form.woocommerce-cart-form, form.checkout, form#order_review").length))if(p.initialized=!0,"cart"==p.source&&0==woocommerce_bluesnap_payment_request_params.cart_compatible)p.showError('<div class="woocommerce-info">'+p.getErrorMessage("not_compatible_with_cart")+"</div>");else if(p.cartCompatibleWithCurrentType())switch(p.type){case"apple_pay":p.createButton();break;case"google_pay":n("#wc-bluesnap-google-pay-wrapper").length&&(n("#wc-bluesnap-google-pay-wrapper.requires-account").length?n("#wc-bluesnap-google-pay-wrapper, #wc-bluesnap-google-pay-button-separator").show():p.loadJS("https://pay.google.com/gp/p/js/pay.js",function(){p.createButton(),n(document.body).on("updated_cart_totals",function(){p.createButton()})}))}else p.showError('<div class="woocommerce-info">'+p.getErrorMessage("device_not_compat_with_cart")+"</div>")},loadJS:function(e,t){var a=document.createElement("script");a.onload=function(){t()},a.src=e,document.head.appendChild(a)},createButton:function(){switch(p.type){case"apple_pay":ApplePaySession.canMakePayments()?(n("<style></style>").attr("id","wc-bluesnap-apple-pay-css").html("#wc-bluesnap-apple-pay-wrapper, #wc-bluesnap-apple-pay-button-separator { display: block !important; }").appendTo("body"),n(document).on("click","#wc-bluesnap-apple-pay-wrapper a.apple-pay-button",p.applePayClicked)):p.showError('<div class="woocommerce-info">'+p.getErrorMessage("not_able_to_make_payments")+"</div>");break;case"google_pay":const t=p.googlePayGetPaymentsClient();var e=Object.assign({},p.googlePayParams.baseRequest,{allowedPaymentMethods:[p.googlePayGetBaseCardPaymentMethod()]});t.isReadyToPay(e).then(function(e){e.result&&(n("#wc-bluesnap-google-pay-wrapper, #wc-bluesnap-google-pay-button-separator").show(),p.googlePayCreateButton(t))}).catch(function(e){console.error(e)})}},googlePayGetCardPaymentMethod:function(){var e={type:"PAYMENT_GATEWAY",parameters:{gateway:"bluesnap",gatewayMerchantId:woocommerce_bluesnap_payment_request_params.merchant_id}};return Object.assign({},p.googlePayGetBaseCardPaymentMethod(),{tokenizationSpecification:e})},googlePayGetBaseCardPaymentMethod:function(){return{type:"CARD",parameters:{allowedAuthMethods:p.googlePayParams.allowedCardAuthMethods,allowedCardNetworks:p.googlePayParams.allowedCardNetworks}}},googlePayInit:function(e){var t={environment:woocommerce_bluesnap_payment_request_params.test_mode?"TEST":"PRODUCTION",merchantInfo:{merchantName:woocommerce_bluesnap_payment_request_params.merchant_soft_descriptor,merchantId:woocommerce_bluesnap_payment_request_params.google_pay_merchant_id},paymentDataCallbacks:{onPaymentAuthorized:p.googlePayPaymentAuthorized}};return void 0!==e&&e.shippingAddressRequired&&Object.assign(t.paymentDataCallbacks,{onPaymentDataChanged:p.googlePayOnPaymentDataChanged}),new google.payments.api.PaymentsClient(t)},googlePayOnPaymentDataChanged:function(s){return new Promise(function(e,t){var a=s.shippingAddress,o=s.shippingOptionData,n={};let r=null;"SHIPPING_OPTION"===s.callbackTrigger&&(r=o.id);try{n.newTransactionInfo=p.googlePayCalculateNewTransactionInfo(a,r),n.newShippingOptionParameters=p.transformShippingForGpay(n.newTransactionInfo.shippingMethods),delete n.newTransactionInfo.shippingMethods,e(n)}catch(e){(e="object"==typeof e&&e.intent?e:{reason:"OTHER_ERROR",message:"Could not get shipping information from the server",intent:"SHIPPING_ADDRESS"}).reason=e.reason&&"invalid_shipping_address"===e.reason?"SHIPPING_ADDRESS_INVALID":e.reason,t(e)}})},transformShippingForGpay:function(e){return e&&0!==e.length?(shippingOptions=[],e.forEach(e=>{shippingOptions.push({id:e.identifier,label:e.label+"("+e.amount+")",description:e.detail})}),{defaultSelectedOptionId:shippingOptions[0].id,shippingOptions:shippingOptions}):{}},googlePayCalculateNewTransactionInfo:function(e,t){return null!==t&&p.updateShippingMethod({identifier:t}),p.getShippingOptions(e)},googlePayGetPaymentsClient:function(e){return p.googlePayInit(e)},googlePayCreateButton:function(e){e=e.createButton({onClick:p.googlePayClicked});document.getElementById("wc-bluesnap-google-pay-button-cont").appendChild(e)},getSupportedPaymentRequestType:function(){return void 0!==window.ApplePaySession&&woocommerce_bluesnap_payment_request_params.apple_pay_enabled?"apple_pay":!(void 0===window.PaymentRequest||!woocommerce_bluesnap_payment_request_params.google_pay_enabled)&&"google_pay"},cartCompatibleWithCurrentType:function(){switch(p.type){case"apple_pay":return void 0!==window.ApplePaySession&&ApplePaySession.supportsVersion(parseInt(woocommerce_bluesnap_payment_request_params.version_required[p.type]));case"google_pay":return!0;default:return!1}},googlePayClicked:function(e){e.preventDefault();e=p.googlePayGetPaymentDataRequest();p.googlePayGetPaymentsClient(e).loadPaymentData(e).catch(function(e){})},googlePayGetPaymentDataRequest:function(){var e=p.getRequestData();let t=Object.assign({},p.googlePayParams.baseRequest);var a=p.googlePayGetCardPaymentMethod();return a.parameters=Object.assign(a.parameters,e.billingAddressInfo),t.allowedPaymentMethods=[a],t.transactionInfo=e.transactionInfo,t.merchantInfo={merchantId:woocommerce_bluesnap_payment_request_params.google_pay_merchant_id,merchantName:woocommerce_bluesnap_payment_request_params.merchant_soft_descriptor},(t=Object.assign(t,e.shippingAddressInfo)).callbackIntents=["PAYMENT_AUTHORIZATION"],t.shippingOptionRequired=t.shippingAddressRequired,t.shippingOptionRequired&&(t.callbackIntents=t.callbackIntents.concat(["SHIPPING_ADDRESS","SHIPPING_OPTION"])),t.emailRequired=!0,t},applePayClicked:function(e){if(e.preventDefault(),null===p.session){p.blockForm();e=p.getRequestData();if(!1!==e){try{var t=p.session=new ApplePaySession(woocommerce_bluesnap_payment_request_params.version_required[p.type],e)}catch(e){return p.showError('<div class="woocommerce-error">'+p.getErrorMessage("device_not_compat_with_cart")+"</div>"),n("#wc-bluesnap-apple-pay-css").html("#wc-bluesnap-apple-pay-wrapper, #wc-bluesnap-apple-pay-button-separator { display: none !important; }"),void p.unblockForm()}t.onvalidatemerchant=p.applePayValidateMerchant,t.onshippingcontactselected=p.applePayUpdateShippingInfo,t.onshippingmethodselected=p.applePayUpdateShippingMethod,t.onpaymentauthorized=p.applePayPaymentAuthorized,t.oncancel=p.handleCancel,t.begin()}else p.unblockForm(),alert("Apple Pay could not be initialized. Try an alternate form of payment")}},applePayValidateMerchant:function(e){n.ajax({url:p.getAjaxUrl("create_apple_wallet"),method:"POST",dataType:"json",data:{security:woocommerce_bluesnap_payment_request_params.nonces.create_apple_wallet,validation_url:e.validationURL,payment_request_type:p.type,payment_request_source:p.source}}).then(function(e){var t;e.success?(t=window.atob(e.data.walletToken),p.session.completeMerchantValidation(JSON.parse(t))):p.handleError(e)},p.handleError)},getShippingOptions:function(e,t){var a=!1;return n.ajax({url:p.getAjaxUrl("get_shipping_options"),method:"POST",dataType:"json",async:"apple_pay"===p.type,data:{security:woocommerce_bluesnap_payment_request_params.nonces.get_shipping_options,address:window.btoa(unescape(encodeURIComponent(JSON.stringify(e)))),payment_request_type:p.type,payment_request_source:p.source}}).done(t||function(e){if(e.success)a=e.data;else if(e.data&&e.data.errorCode)throw{reason:e.data.errorCode,message:e.data.message||"",intent:"SHIPPING_ADDRESS"}}).fail(p.handleError),a},applePayUpdateShippingInfo:function(e){e=e.shippingContact;p.getShippingOptions(e,function(e){var t=e.data;e.success?p.session.completeShippingContactSelection({status:ApplePaySession.STATUS_SUCCESS,newShippingMethods:t.shippingMethods,newLineItems:t.lineItems,newTotal:t.total}):(e=new ApplePayError("shippingContactInvalid","postalAddress",t.message),p.session.completeShippingContactSelection({status:ApplePaySession.STATUS_FAILURE,errors:[e],newShippingMethods:[],newLineItems:t.lineItems,newTotal:t.total}))})},applePayUpdateShippingMethod:function(e){e=e.shippingMethod;p.updateShippingMethod(e,function(e){var t=e.data;e.success?p.session.completeShippingMethodSelection({status:ApplePaySession.STATUS_SUCCESS,newLineItems:t.lineItems,newTotal:t.total}):p.session.completeShippingMethodSelection({status:ApplePaySession.STATUS_FAILURE,newLineItems:t.lineItems,newTotal:t.total})})},updateShippingMethod:function(e,t){n.ajax({url:p.getAjaxUrl("update_shipping_method"),method:"POST",dataType:"json",async:"apple_pay"===p.type,data:{security:woocommerce_bluesnap_payment_request_params.nonces.update_shipping_method,method:[e.identifier],payment_request_type:p.type,payment_request_source:p.source}}).done(t).fail(p.handleError)},googlePayPaymentAuthorized:function(e){return new Promise(function(t,a){function o(e){e=e&&e.data&&"string"==typeof e.data?e.data:p.getErrorMessage("checkout_error");a({intent:"PAYMENT_AUTHORIZATION",message:e,reason:"PAYMENT_DATA_INVALID"})}p.paymentRequestPaymentAuthorized({payment:e},function(e){e.resolveFn=t;try{void 0!==e.success&&!1===e.success?p.handleError(e):void 0!==e.result&&p.handleWCResponse(e)}catch(e){o(e)}},function(e){e.resolveFn=t;try{p.handleError(e)}catch(e){o(e)}})})},applePayPaymentAuthorized:function(e){p.paymentRequestPaymentAuthorized(e,function(e){void 0!==e.success&&!1===e.success?p.handleError(e):void 0!==e.result&&p.handleWCResponse(e)},p.handleError)},paymentRequestPaymentAuthorized:function(e,t,a){e=e.payment;n.ajax({url:p.getAjaxUrl("create_pmr_payment"),method:"POST",dataType:"json",data:{_wpnonce:woocommerce_bluesnap_payment_request_params.nonces.checkout,payment_token:btoa(encodeURIComponent(JSON.stringify(e)).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)})),payment_request_type:p.type,payment_request_source:p.source,is_change_payment_method:woocommerce_bluesnap_payment_request_params.change_payment_page}}).then(t,a)},getAjaxUrl:function(e){return woocommerce_bluesnap_payment_request_params.wc_ajax_url.toString().replace("%%endpoint%%","bluesnap_"+e)},getRequestData:function(){var t=!1;return n.ajax({url:p.getAjaxUrl("get_payment_request"),method:"POST",dataType:"json",data:{security:woocommerce_bluesnap_payment_request_params.nonces.get_payment_request,payment_request_type:p.type,payment_request_source:p.source,is_change_payment_method:woocommerce_bluesnap_payment_request_params.change_payment_page},async:!1}).done(function(e){e.success&&(t=e.data)}).fail(function(){}),t},handleError:function(e){switch(p.type){case"apple_pay":p.session.completePayment(ApplePaySession.STATUS_FAILURE);break;case"google_pay":throw e}p.session=null,p.unblockForm(),n(document.body).trigger("update_checkout")},handleSuccess:function(e){switch(p.type){case"apple_pay":p.session.completePayment(ApplePaySession.STATUS_SUCCESS);break;case"google_pay":e&&"function"==typeof e.resolveFn&&e.resolveFn({transactionState:"SUCCESS"})}p.session=null},handleCancel:function(){p.type,p.session=null,p.unblockForm(),n(document.body).trigger("update_checkout")},handleWCResponse:function(t){try{if("success"!==t.result)throw"failure"===t.result?"Result failure":"Invalid response";p.handleSuccess(t),-1===t.redirect.indexOf("https://")||-1===t.redirect.indexOf("http://")?window.location=t.redirect:window.location=decodeURI(t.redirect)}catch(e){if(!0===t.reload)window.location.reload();else if(!0===t.refresh&&n(document.body).trigger("update_checkout"),t.messages?p.showError(t.messages):p.showError('<div class="woocommerce-error">'+p.getErrorMessage("checkout_error")+"</div>"),!1!==p.type){if(!t||"function"!=typeof t.resolveFn)throw e;a=t.messages?(a=t.messages,(o=document.createElement("div")).innerHTML=a,(o.textContent||o.innerText||"").trim()):e;t.resolveFn({transactionState:"ERROR",error:{intent:"PAYMENT_AUTHORIZATION",message:a,reason:"PAYMENT_DATA_INVALID"}})}}var a,o},getForm:function(){var e=n("form.woocommerce-checkout");return(e=(e=e.length?e:n("form#add_payment_method")).length?e:n("form#order_review")).length||(e=n("form.woocommerce-cart-form")).length&&(e=e.closest(".woocommerce")),e},blockForm:function(){p.getForm().addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblockForm:function(){p.getForm().removeClass("processing").unblock()},showError:function(e){var t,a=p.getForm();a.length?(n(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),a.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+e+"</div>"),p.unblockForm(),(t=n(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout")).length||(t=n(a)),n.scroll_to_notices(t),n(document.body).trigger("checkout_error")):console.error(e)},getErrorMessage:function(e){let t=!!woocommerce_bluesnap_payment_request_params.i18n[p.type]&&woocommerce_bluesnap_payment_request_params.i18n[p.type][e]||woocommerce_bluesnap_payment_request_params.i18n[e]||null;return t=t||"An unknown error prevented the payment method from loading ("+p.type+":"+e+")"}};n(document.body).on("updated_checkout",function(){p.init()}),n(p.init)}(jQuery);
//# sourceMappingURL=../../source/_maps/js/frontend/woocommerce-bluesnap-payment-request.min.js.map
